jIO.addStorageType("revision",function(a,d){var c={},b={};a=a||{};c=d.basicStorage(a,d);b.doc_tree_suffix=".revision_tree.json";b.sub_storage=a.sub_storage;b.RevisionStorage=function(){};c.specToStore=function(){return{sub_storage:b.sub_storage}};b.clone=function(e){var f=JSON.stringify(e);if(f===undefined){return undefined}return JSON.parse(f)};b.generateUuid=function(){var e=function(){var g,f=Math.floor(Math.random()*65536).toString(16);for(g=f.length;g<4;g+=1){f="0"+f}return f};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()};b.hashCode=function(e){return hex_sha256(e)};b.checkDocumentRevisionFormat=function(f){var e=function(g){return{status:31,statusText:"Wrong Revision Format",error:"wrong_revision_format",message:g,reason:"Revision is wrong"}};if(typeof f._rev==="string"){if(/^[0-9]+-[0-9a-zA-Z]+$/.test(f._rev)===false){return e("The document revision does not match ^[0-9]+-[0-9a-zA-Z]+$")}}if(typeof f._revs==="object"){if(typeof f._revs.start!=="number"||typeof f._revs.ids!=="object"||typeof f._revs.ids.length!=="number"){return e("The document revision history is not well formated")}}if(typeof f._revs_info==="object"){if(typeof f._revs_info.length!=="number"){return e("The document revision information is not well formated")}}};b.newDocTree=function(){return{children:[]}};b.revsInfoToHistory=function(e){var f,g={start:0,ids:[]};e=e||[];if(e.length>0){g.start=parseInt(e[0].rev.split("-")[0],10)}for(f=0;f<e.length;f+=1){g.ids.push(e[f].rev.split("-")[1])}return g};b.revisionHistoryToList=function(f){var g,h=f.start,e=[];for(g=0;g<f.ids.length;g+=1,h-=1){e.push(h+"-"+f.ids[g])}return e};b.revisionListToRevsInfo=function(h,f){var i,e=[],g;for(g=0;g<h.length;g+=1){e.push({rev:h[g],status:"missing"})}i=function(k,j){var m,l;if(k<0){return}for(l=0;l<j.children.length;l+=1){m=j.children[l];if(m.rev===h[k]){e[k].status=m.status;i(k-1,m)}}};i(h.length-1,f);return e};b.fillDocumentRevisionProperties=function(f,e){if(f._revs_info){f._revs=b.revsInfoToHistory(f._revs_info)}else{if(f._revs){f._revs_info=b.revisionListToRevsInfo(b.revisionHistoryToList(f._revs),e)}else{if(f._rev){f._revs_info=b.getRevisionInfo(f._rev,e);f._revs=b.revsInfoToHistory(f._revs_info)}else{f._revs_info=[];f._revs={start:0,ids:[]}}}}if(f._revs.start>0){f._rev=f._revs.start+"-"+f._revs.ids[0]}else{delete f._rev}};b.generateNextRevision=function(i,h){var f,g,e,j;i=b.clone(i)||{};g=i._revs;e=i._revs_info;delete i._rev;delete i._revs;delete i._revs_info;f=JSON.stringify(i)+JSON.stringify(g)+JSON.stringify(h?true:false);g.start+=1;g.ids.unshift(b.hashCode(f));i._revs=g;i._rev=g.start+"-"+g.ids[0];e.unshift({rev:i._rev,status:h?"deleted":"available"});i._revs_info=e;return i};b.getRevisionInfo=function(f,e){var g;g=function(j){var k,l,h;for(k=0;k<j.children.length;k+=1){l=j.children[k];if(l.rev===f){return[{rev:l.rev,status:l.status}]}h=g(l);if(h.length>0||f===undefined){h.push({rev:l.rev,status:l.status});return h}}return[]};return g(e)};b.updateDocumentTree=function(g,f){var e,i,h;g=b.clone(g);e=g._revs_info;i=function(k,j){var l,n,m;if(j.length===0){return}m=j.pop();for(l=0;l<k.children.length;l+=1){n=k.children[l];if(n.rev===m.rev){return i(n,j)}}k.children.unshift({rev:m.rev,status:m.status,children:[]});i(k.children[0],j)};i(f,b.clone(e))};b.send=function(h,f,e,g){c.addJob(h,b.sub_storage,f,e,function(i){g(undefined,i)},function(i){g(i,undefined)})};b.getWinnerRevsInfo=function(f){var e=[],g;g=function(h,k){var j;if(h.rev){k.unshift({rev:h.rev,status:h.status})}if(h.children.length===0){if(e.length===0||(e[0].status!=="available"&&k[0].status==="available")||(k[0].status==="available"&&e.length<k.length)){e=b.clone(k)}}for(j=0;j<h.children.length;j+=1){g(h.children[j],k)}k.shift()};g(f,[]);return e};b.getConflicts=function(h,f){var e=[],g;g=function(j){var k;if(j.rev===h){return}if(j.children.length===0){if(j.status!=="deleted"){e.push(j.rev)}}for(k=0;k<j.children.length;k+=1){g(j.children[k])}};g(f);return e.length===0?undefined:e};b.get=function(f,e,g){b.send("get",f,e,g)};b.put=function(f,e,g){b.send("put",f,e,g)};b.remove=function(f,e,g){b.send("remove",f,e,g)};b.getAttachment=function(f,e,g){b.send("getAttachment",f,e,g)};b.putAttachment=function(f,e,g){b.send("putAttachment",f,e,g)};b.removeAttachment=function(f,e,g){b.send("removeAttachment",f,e,g)};b.getDocument=function(f,e,g){f=b.clone(f);f._id=f._id+"."+f._rev;delete f._attachment;delete f._rev;delete f._revs;delete f._revs_info;b.get(f,e,g)};b.putDocument=function(f,e,g){f=b.clone(f);f._id=f._id+"."+f._rev;delete f._attachment;delete f._data;delete f._mimetype;delete f._rev;delete f._revs;delete f._revs_info;b.put(f,e,g)};b.getRevisionTree=function(f,e,g){f=b.clone(f);f._id=f._id+b.doc_tree_suffix;b.get(f,e,g)};b.getAttachmentList=function(k,g,l){var e,f,j="ok",i=[],h=0;f=function(m,n){return function(o,p){if(j!=="ok"){return}h-=1;if(o){if(o.status===404){i.push(undefined)}else{j="error";return l(o,undefined)}}i.push({_attachment:m,_data:p,_mimetype:n.content_type});if(h===0){j="finished";l(undefined,i)}}};for(e in k._attachments){if(k._attachments.hasOwnProperty(e)){h+=1;b.getAttachment({_id:k._id,_attachment:e},g,f(e,k._attachments[e]))}}if(h===0){l(undefined,[])}};b.putAttachmentList=function(k,h,m,l){var f,n,e="ok",j=0,g;m=m||[];n=function(i){return function(p,o){if(e!=="ok"){return}j-=1;if(p){e="error";return l(p,undefined)}if(j===0){e="finished";l(undefined,{id:k._id,ok:true})}}};for(f=0;f<m.length;f+=1){g=m[f];if(g!==undefined){j+=1;g._id=k._id+"."+k._rev;b.putAttachment(g,h,n(f))}}if(j===0){return l(undefined,{id:k._id,ok:true})}};b.putDocumentTree=function(g,f,e,h){e=b.clone(e);e._id=g._id+b.doc_tree_suffix;b.put(e,f,h)};b.notFoundError=function(e,f){return{status:404,statusText:"Not Found",error:"not_found",message:e,reason:f}};b.conflictError=function(e,f){return{status:409,statusText:"Conflict",error:"conflict",message:e,reason:f}};b.revisionGenericRequest=function(k,h,j,f){var i,e,g,l={};if(j.doc_id){k._id=j.doc_id}if(j.attachment_id){k._attachment=j.attachment_id}l.begin=function(){var m;k._id=k._id||b.generateUuid();if(j.revision_needed&&!k._rev){return f(b.conflictError("Document update conflict","No document revision was provided"),undefined)}m=b.checkDocumentRevisionFormat(k);if(m!==undefined){return f(m,undefined)}b.getRevisionTree(k,h,l.getRevisionTree)};l.getRevisionTree=function(q,o){var p,n=k._rev,m=k._revs||k._revs_info?false:true;if(q){if(q.status!==404){q.message="Cannot get document revision tree";return f(q,undefined)}}e=o||b.newDocTree();if(j.get||j.getAttachment){if(!k._rev){p=b.getWinnerRevsInfo(e);if(p.length===0){return f(b.notFoundError("Document not found","missing"),undefined)}if(p[0].status==="deleted"){return f(b.notFoundError("Document not found","deleted"),undefined)}k._rev=p[0].rev}b.fillDocumentRevisionProperties(k,e);return b.getDocument(k,h,l.getDocument)}b.fillDocumentRevisionProperties(k,e);if(m){if(n&&k._revs_info.length===0){k._rev=n;k._revs={start:parseInt(n.split("-")[0],10),ids:[n.split("-")[1]]};k._revs_info=[{rev:n,status:"missing"}]}k=b.generateNextRevision(k,j.remove)}if(k._revs_info.length>1){i={_id:k._id,_rev:k._revs_info[1].rev};if(!m&&j.putAttachment){i._rev=k._revs_info[0].rev}}k._revs_info[0].status=(j.remove?"deleted":"available");b.updateDocumentTree(k,e);if(i){return b.getDocument(i,h,l.getDocument)}if(j.remove||j.removeAttachment){return f(b.notFoundError("Unable to remove an inexistent document","missing"),undefined)}b.putDocument(k,h,l.putDocument)};l.getDocument=function(o,p){var n,m;if(o){if(o.status===404){if(j.remove||j.removeAttachment){return f(b.conflictError("Document update conflict","Document is missing"),undefined)}if(j.get){return f(b.notFoundError("Unable to find the document","missing"),undefined)}p={}}else{o.message="Cannot get document";return f(o,undefined)}}if(j.get){p._id=k._id;p._rev=k._rev;if(h.conflicts===true){m=b.getConflicts(k._rev,e);if(m){p._conflicts=m}}if(h.revs===true){p._revisions=k._revs}if(h.revs_info===true){p._revs_info=k._revs_info}return f(undefined,p)}if(j.putAttachment||j.removeAttachment){for(n in p){if(p.hasOwnProperty(n)&&!n.match("^_")){k[n]=p[n]}}}if(j.remove){b.putDocumentTree(k,h,e,l.putDocumentTree)}else{b.getAttachmentList(p,h,l.getAttachmentList)}};l.getAttachmentList=function(p,n){var o,m=false;if(p){p.message="Cannot get attachment";return f(p,undefined)}g=n||[];if(j.getAttachment){for(o=0;o<g.length;o+=1){if(g[o]&&k._attachment===g[o]._attachment){return f(undefined,g[o]._data)}}return f(b.notFoundError("Unable to get an inexistent attachment","missing"),undefined)}if(j.remove_from_attachment_list){for(o=0;o<g.length;o+=1){if(g[o]&&j.remove_from_attachment_list._attachment===g[o]._attachment){m=true;g[o]=undefined;break}}if(!m){return f(b.notFoundError("Unable to remove an inexistent attachment","missing"),undefined)}}b.putDocument(k,h,l.putDocument)};l.putDocument=function(p,n){var o,m=false;if(p){p.message="Cannot post the document";return f(p,undefined)}if(j.add_to_attachment_list){g=g||[];for(o=0;o<g.length;o+=1){if(g[o]&&j.add_to_attachment_list._attachment===g[o]._attachment){m=true;g[o]=j.add_to_attachment_list;break}}if(!m){g.unshift(j.add_to_attachment_list)}}b.putAttachmentList(k,h,g,l.putAttachmentList)};l.putAttachmentList=function(n,m){if(n){n.message="Cannot copy attacments to the document";return f(n,undefined)}b.putDocumentTree(k,h,e,l.putDocumentTree)};l.putDocumentTree=function(o,m){var n;if(o){o.message="Cannot update the document history";return f(o,undefined)}n={ok:true,id:k._id,rev:k._rev};if(j.putAttachment||j.removeAttachment||j.getAttachment){n.attachment=k._attachment}f(undefined,n)};l.begin()};c.post=function(e){b.revisionGenericRequest(e.cloneDoc(),e.cloneOption(),{},function(g,f){if(g){return c.error(g)}c.success(f)})};c.put=function(e){b.revisionGenericRequest(e.cloneDoc(),e.cloneOption(),{},function(g,f){if(g){return c.error(g)}c.success(f)})};c.putAttachment=function(e){b.revisionGenericRequest(e.cloneDoc(),e.cloneOption(),{doc_id:e.getDocId(),attachment_id:e.getAttachmentId(),add_to_attachment_list:{_attachment:e.getAttachmentId(),_mimetype:e.getAttachmentMimeType(),_data:e.getAttachmentData()},putAttachment:true},function(g,f){if(g){return c.error(g)}c.success(f)})};c.remove=function(e){if(e.getAttachmentId()){return c.removeAttachment(e)}b.revisionGenericRequest(e.cloneDoc(),e.cloneOption(),{revision_needed:true,remove:true},function(g,f){if(g){return c.error(g)}c.success(f)})};c.removeAttachment=function(e){b.revisionGenericRequest(e.cloneDoc(),e.cloneOption(),{doc_id:e.getDocId(),attachment_id:e.getAttachmentId(),revision_needed:true,removeAttachment:true,remove_from_attachment_list:{_attachment:e.getAttachmentId()}},function(g,f){if(g){return c.error(g)}c.success(f)})};c.get=function(e){if(e.getAttachmentId()){return c.getAttachment(e)}b.revisionGenericRequest(e.cloneDoc(),e.cloneOption(),{get:true},function(g,f){if(g){return c.error(g)}c.success(f)})};c.getAttachment=function(e){b.revisionGenericRequest(e.cloneDoc(),e.cloneOption(),{doc_id:e.getDocId(),attachment_id:e.getAttachmentId(),getAttachment:true},function(g,f){if(g){return c.error(g)}c.success(f)})};c.allDocs=function(h){var f,e={total_rows:0,rows:[]},g={};g.finished=0;g.falseResponseGenerator=function(i,j){j(undefined,i)};g.fillResultGenerator=function(i){return function(l,k){var n,m,j;if(l){return c.error(l)}j=b.getWinnerRevsInfo(k);n=f.document_revisions[i+"."+j[0].rev];if(n){m={id:i,key:i,value:{rev:j[0].rev}};if(n.doc&&h.getOption("include_docs")){n.doc._id=i;n.doc._rev=j[0].rev;m.doc=n.doc}e.rows.push(m);e.total_rows+=1}g.success()}};g.success=function(){g.finished-=1;if(g.finished===0){c.success(e)}};b.send("allDocs",null,h.cloneOption(),function(p,l){var n,m,q,k,o;if(p){return c.error(p)}k=/\.revision_tree\.json$/;f={revision_trees:{},document_revisions:{}};while(l.rows.length>0){q=l.rows.shift();o=k.exec(q.id);if(o){o=o.input.substring(0,o.index);f.revision_trees[q.id]={id:o};if(q.doc){f.revision_trees[q.id].doc=q.doc}}else{f.document_revisions[q.id]={id:q.id.split(".").slice(0,-1),rev:q.id.split(".").slice(-1)};if(q.doc){f.document_revisions[q.id].doc=q.doc}}}g.finished+=1;for(n in f.revision_trees){if(f.revision_trees.hasOwnProperty(n)){g.finished+=1;if(f.revision_trees[n].doc){g.falseResponseGenerator(f.revision_trees[n].doc,g.fillResultGenerator(f.revision_trees[n].id))}else{b.getRevisionTree({_id:f.revision_trees[n].id},h.cloneOption(),g.fillResultGenerator(f.revision_trees[n].id))}}}g.success()})};b.RevisionStorage();return c});